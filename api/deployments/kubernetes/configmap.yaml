apiVersion: v1
kind: ConfigMap
metadata:
  name: lexure-mvp-config
  namespace: lexure-mvp
  labels:
    app: payment-watchdog-mvp
data:
  config.yaml: |
    server:
      port: "8085"  # Changed from 8080/8081/8083 to avoid lexure-compliance conflicts
      host: "0.0.0.0"
      https: false
      cert_file: "/app/certs/tls.crt"
      key_file: "/app/certs/tls.key"
    
    database:
      host: "lexure-mvp-postgres"
      port: 5432
      name: "lexure_intelligence_mvp"
      user: "postgres"
      password: "password"
      ssl_mode: "disable"
    
    stripe:
      secret_key: ""
      webhook_secret: "whsec_b764fea1193fb388a59481d204feae98d7a057fc15a03b2e4d71e704b4c17349"
      publishable_key: ""
    
    xero:
      client_id: "0F8E50EAE9A1459F90822CF0C25EDCA8"
      client_secret: "RJuOZzXkw9QNwwLLl9LsKE39dvZM78Hmfyqrui31H5Bm-DaQ"
      redirect_uri: "http://localhost:8085/api/v1/xero/auth/callback"
    
    email:
      provider: "smtp"
      host: "localhost"
      port: 587
      username: ""
      password: ""
      from_email: "noreply@payment-watchdog.com"
      from_name: "Lexure Intelligence"
    
    log:
      level: "info"
  
  # Migration files
  001_initial_schema.up.sql: |
    -- Enable UUID extension
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Create companies table
    CREATE TABLE companies (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(255) NOT NULL,
        domain VARCHAR(255),
        status VARCHAR(50) DEFAULT 'active',
        stripe_account_id VARCHAR(255),
        alert_settings JSONB DEFAULT '{}',
        retry_settings JSONB DEFAULT '{}',
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Create payment_failure_events table
    CREATE TABLE payment_failure_events (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        company_id VARCHAR(255) NOT NULL,
        provider_id VARCHAR(100) NOT NULL,
        event_id VARCHAR(255) NOT NULL,
        event_type VARCHAR(255) NOT NULL,
        payment_intent_id VARCHAR(255),
        amount DECIMAL(10,2),
        currency VARCHAR(10) DEFAULT 'AUD',
        customer_id VARCHAR(255),
        customer_email VARCHAR(255),
        customer_name VARCHAR(255),
        failure_reason VARCHAR(255),
        failure_code VARCHAR(100),
        failure_message TEXT,
        status VARCHAR(50) DEFAULT 'received',
        processed_at TIMESTAMP WITH TIME ZONE,
        alerted_at TIMESTAMP WITH TIME ZONE,
        raw_event_data JSONB DEFAULT '{}',
        normalized_data JSONB DEFAULT '{}',
        webhook_received_at TIMESTAMP WITH TIME ZONE NOT NULL,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Create retry_attempts table
    CREATE TABLE retry_attempts (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        payment_failure_id UUID NOT NULL,
        company_id VARCHAR(255) NOT NULL,
        attempt_number INTEGER NOT NULL,
        retry_amount DECIMAL(10,2),
        retry_method VARCHAR(50),
        status VARCHAR(50) DEFAULT 'pending',
        provider_retry_id VARCHAR(255),
        provider_response JSONB DEFAULT '{}',
        scheduled_at TIMESTAMP WITH TIME ZONE,
        attempted_at TIMESTAMP WITH TIME ZONE,
        completed_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Create customer_communications table
    CREATE TABLE customer_communications (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        payment_failure_id UUID NOT NULL,
        company_id VARCHAR(255) NOT NULL,
        channel VARCHAR(50),
        template_id VARCHAR(255),
        subject VARCHAR(500),
        content TEXT,
        status VARCHAR(50) DEFAULT 'pending',
        provider_message_id VARCHAR(255),
        delivery_response JSONB DEFAULT '{}',
        sent_at TIMESTAMP WITH TIME ZONE,
        delivered_at TIMESTAMP WITH TIME ZONE,
        opened_at TIMESTAMP WITH TIME ZONE,
        clicked_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Create indexes
    CREATE INDEX idx_companies_status ON companies(status);
    CREATE INDEX idx_companies_stripe_account ON companies(stripe_account_id);

    CREATE INDEX idx_payment_failures_company ON payment_failure_events(company_id);
    CREATE INDEX idx_payment_failures_provider ON payment_failure_events(provider_id);
    CREATE INDEX idx_payment_failures_event_id ON payment_failure_events(event_id);
    CREATE INDEX idx_payment_failurs_status ON payment_failure_events(status);
    CREATE INDEX idx_payment_failures_customer ON payment_failure_events(customer_id);
    CREATE INDEX idx_payment_failures_created ON payment_failure_events(created_at);

    CREATE INDEX idx_retry_attempts_failure ON retry_attempts(payment_failure_id);
    CREATE INDEX idx_retry_attempts_company ON retry_attempts(company_id);
    CREATE INDEX idx_retry_attempts_status ON retry_attempts(status);

    CREATE INDEX idx_communications_failure ON customer_communications(payment_failure_id);
    CREATE INDEX idx_communications_company ON customer_communications(company_id);
    CREATE INDEX idx_communications_status ON customer_communications(status);
    CREATE INDEX idx_communications_channel ON customer_communications(channel);

  002_retry_service.up.sql: |
    -- Migration 002: Add retry service tables for Sprint 2
    -- This migration adds the retry_jobs table for the enhanced retry service

    -- Create retry_jobs table for Sprint 2 retry service
    CREATE TABLE retry_jobs (
        id VARCHAR(255) PRIMARY KEY,
        job_type VARCHAR(100) NOT NULL,
        company_id VARCHAR(255) NOT NULL,
        data JSONB DEFAULT '{}',
        retry_count INTEGER DEFAULT 0,
        max_retries INTEGER DEFAULT 3,
        status VARCHAR(50) DEFAULT 'pending',
        error TEXT,
        next_retry_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        completed_at TIMESTAMP WITH TIME ZONE
    );

    -- Create indexes for retry_jobs table
    CREATE INDEX idx_retry_jobs_company ON retry_jobs(company_id);
    CREATE INDEX idx_retry_jobs_status ON retry_jobs(status);
    CREATE INDEX idx_retry_jobs_next_retry ON retry_jobs(next_retry_at);
    CREATE INDEX idx_retry_jobs_created ON retry_jobs(created_at);

    -- Add comment to table
    COMMENT ON TABLE retry_jobs IS 'Sprint 2 retry service jobs with exponential backoff and dead letter queue support';
